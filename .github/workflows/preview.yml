name: Deploy Preview

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    name: Build & Deploy Preview
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: 'pnpm'

      - run: pnpm install
        env:
          NODE_ENV: development
      - run: pnpm build
        env:
          NODE_ENV: production

      - name: Deploy Worker Version
        id: deploy-worker-preview
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: versions upload --message="PR#${{ github.event.number }}" -c .output/server/wrangler.json
          packageManager: 'pnpm'

      - name: Comment Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = process.env.PREVIEW_URL;
            const status = 'âœ… Ready';
            const prNumber = context.issue.number;

            const body = `
            ðŸš€ **Preview Deployment Ready!**

            | Application | Preview URL | Status |
            | :--- | :--- | :--- |
            | Render MD | [Visit Preview](${url}) | ${status} |
            `;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        env:
          PREVIEW_URL: ${{ steps.deploy-worker-preview.outputs.deployment-url }}
